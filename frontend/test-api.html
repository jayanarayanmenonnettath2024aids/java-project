<!DOCTYPE html>
<html>
<head>
    <title>API Test - Debug Receipts</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        button { padding: 10px 20px; margin: 5px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #5568d3; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 4px; overflow-x: auto; max-height: 500px; }
        input { padding: 8px; margin: 5px; width: 300px; border: 1px solid #ddd; border-radius: 4px; }
        .info { background: #e3f2fd; padding: 10px; border-radius: 4px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Receipt API Debug Tool</h1>
        
        <div class="info">
            <strong>Instructions:</strong>
            <ol>
                <li>Enter your password for jaya@gmail.com</li>
                <li>Click "Login"</li>
                <li>Click "Get All Receipts"</li>
                <li>Check the response below</li>
            </ol>
        </div>
        
        <h2>1. Login</h2>
        <input type="email" id="email" placeholder="Email" value="jaya@gmail.com">
        <input type="password" id="password" placeholder="Password" value="">
        <button onclick="testLogin()">Login</button>
        <button onclick="clearStorage()">Clear Storage</button>
        
        <h2>2. Get Receipts</h2>
        <button onclick="testGetReceipts()">Get All Receipts</button>
        <button onclick="checkBackend()">Check Backend Status</button>
        
        <h2>Storage Status:</h2>
        <pre id="storageStatus">Checking...</pre>
        
        <h2>Response:</h2>
        <pre id="output">No request made yet...</pre>
    </div>

    <script>
        let token = localStorage.getItem('jwt_token');
        
        function updateStorageStatus() {
            const token = localStorage.getItem('jwt_token');
            const user = localStorage.getItem('current_user');
            let status = '';
            
            if (token) {
                status += `✓ Token: ${token.substring(0, 50)}...\n`;
            } else {
                status += `✗ No token found\n`;
            }
            
            if (user) {
                try {
                    const userObj = JSON.parse(user);
                    status += `✓ User: ${userObj.name} (${userObj.email})\n`;
                    status += `✓ User ID: ${userObj.id}\n`;
                } catch (e) {
                    status += `✗ Invalid user data\n`;
                }
            } else {
                status += `✗ No user found\n`;
            }
            
            document.getElementById('storageStatus').textContent = status;
        }
        
        updateStorageStatus();

        function clearStorage() {
            localStorage.clear();
            token = null;
            updateStorageStatus();
            document.getElementById('output').innerHTML = '<span class="success">✓ Storage cleared!</span>';
        }

        async function checkBackend() {
            try {
                const response = await fetch('http://localhost:8080/actuator/health', {
                    method: 'GET'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('output').innerHTML = `<span class="success">✓ Backend is running!</span>\n${JSON.stringify(data, null, 2)}`;
                } else {
                    document.getElementById('output').innerHTML = `<span class="error">✗ Backend returned status ${response.status}</span>`;
                }
            } catch (error) {
                document.getElementById('output').innerHTML = `<span class="error">✗ Backend is NOT running!\n\nError: ${error.message}\n\nMake sure backend is started on http://localhost:8080</span>`;
            }
        }

        async function testLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!password) {
                document.getElementById('output').innerHTML = '<span class="error">Please enter password!</span>';
                return;
            }
            
            try {
                const response = await fetch('http://localhost:8080/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    token = data.token;
                    localStorage.setItem('jwt_token', token);
                    localStorage.setItem('current_user', JSON.stringify(data));
                    updateStorageStatus();
                    document.getElementById('output').innerHTML = '<span class="success">✓ Login successful!</span>\n\nUser Data:\n' + JSON.stringify(data, null, 2);
                } else {
                    document.getElementById('output').innerHTML = '<span class="error">✗ Login failed!</span>\n' + JSON.stringify(data, null, 2);
                }
            } catch (error) {
                document.getElementById('output').innerHTML = '<span class="error">✗ Error: ' + error.message + '</span>';
            }
        }

        async function testGetReceipts() {
            if (!token) {
                document.getElementById('output').innerHTML = '<span class="error">✗ Please login first!</span>';
                return;
            }
            
            try {
                console.log('Fetching receipts with token:', token.substring(0, 20) + '...');
                
                const response = await fetch('http://localhost:8080/api/receipts?page=0&size=100', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);
                
                if (response.ok) {
                    const receipts = data.content || data;
                    const count = Array.isArray(receipts) ? receipts.length : 0;
                    
                    let output = `<span class="success">✓ Success! Found ${count} receipts</span>\n\n`;
                    output += `Total Elements: ${data.totalElements || count}\n`;
                    output += `Page Size: ${data.size || 'N/A'}\n`;
                    output += `Total Pages: ${data.totalPages || 'N/A'}\n\n`;
                    output += `Full Response:\n${JSON.stringify(data, null, 2)}`;
                    
                    document.getElementById('output').innerHTML = output;
                } else {
                    document.getElementById('output').innerHTML = '<span class="error">✗ Failed!</span>\n' + JSON.stringify(data, null, 2);
                }
            } catch (error) {
                document.getElementById('output').innerHTML = '<span class="error">✗ Error: ' + error.message + '</span>';
            }
        }
        
        // Auto-check backend on load
        setTimeout(checkBackend, 500);
    </script>
</body>
</html>
